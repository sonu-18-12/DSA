WITH category_positions AS (
    SELECT 
        master_cat,
        slave_cat,
        column_no
    FROM {{ ref('temp_assembly_cats') }}
),

product_category AS (
    SELECT category_code
    FROM {{ ref('category') }}
    WHERE category_desc = 'PRODUCT'
),

assembly_attributes AS (
    SELECT DISTINCT 
        a.assembly AS assem,
        a.assembly_sequence AS seq,
        a.category_code AS cat,
        a.attr_code AS atr,
        COALESCE(a.end_of_range_attr, 0) AS end_atr,
        ABS(a.glue_2_seq) AS glue
    FROM {{ ref('sku_attr') }} s
    JOIN {{ ref('sku_attr_assembly') }} a
        ON s.assembly = a.assembly
    WHERE a.glue_2_seq <> 0
),

mapped_attributes AS (
    SELECT 
        aa.assem,
        aa.seq,
        aa.cat,
        aa.atr,
        aa.end_atr,
        cp.column_no,
        cp.master_cat,
        cp.slave_cat
    FROM assembly_attributes aa
    LEFT JOIN category_positions cp
        ON aa.cat = cp.master_cat
),

pivoted_attributes AS (
    SELECT
        assem,
        cat AS category,  -- Include category code here
        MAX(CASE WHEN column_no = 1 THEN atr ELSE NULL END) AS atr_cat_01,
        MAX(CASE WHEN column_no = 2 THEN atr ELSE NULL END) AS atr_cat_02,
        MAX(CASE WHEN column_no = 3 THEN atr ELSE NULL END) AS atr_cat_03,
        MAX(CASE WHEN column_no = 4 THEN atr ELSE NULL END) AS atr_cat_04,
        MAX(CASE WHEN column_no = 5 THEN atr ELSE NULL END) AS atr_cat_05,
        -- Continue up to atr_cat_150
        MAX(CASE WHEN column_no = 150 THEN atr ELSE NULL END) AS atr_cat_150,

        MAX(CASE WHEN column_no = 1 THEN end_atr ELSE NULL END) AS end_atr_cat_01,
        MAX(CASE WHEN column_no = 2 THEN end_atr ELSE NULL END) AS end_atr_cat_02,
        MAX(CASE WHEN column_no = 3 THEN end_atr ELSE NULL END) AS end_atr_cat_03,
        MAX(CASE WHEN column_no = 4 THEN end_atr ELSE NULL END) AS end_atr_cat_04,
        MAX(CASE WHEN column_no = 5 THEN end_atr ELSE NULL END) AS end_atr_cat_05,
        -- Continue up to end_atr_cat_150
        MAX(CASE WHEN column_no = 150 THEN end_atr ELSE NULL END) AS end_atr_cat_150
    FROM mapped_attributes
    GROUP BY assem, cat  -- Include category in GROUP BY
)

SELECT
    ROW_NUMBER() OVER () AS row_id,
    pa.assem AS assembly_id,   -- Assembly info
    pa.category,               -- Category info
    pa.*                       -- Pivoted attributes
FROM pivoted_attributes pa
