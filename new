WITH category_positions AS (
    SELECT 
        master_cat,
        slave_cat,
        column_no
    FROM {{ ref('temp_assembly_cats') }}
),

assembly_attributes AS (
    SELECT DISTINCT 
        a.assembly AS assem,
        a.assembly_sequence AS seq,
        a.category_code AS cat,
        a.attr_code AS atr,
        COALESCE(a.end_of_range_attr, 0) AS end_atr,
        ABS(a.glue_2_seq) AS glue
    FROM {{ ref('sku_attr') }} s
    JOIN {{ ref('sku_attr_assembly') }} a
        ON s.assembly = a.assembly
    WHERE a.glue_2_seq <> 0
),

-- Join to assign column numbers
mapped_attributes AS (
    SELECT 
        aa.assem,
        aa.seq,
        aa.cat,
        aa.atr,
        aa.end_atr,
        cp.column_no
    FROM assembly_attributes aa
    LEFT JOIN category_positions cp
        ON aa.cat = cp.master_cat
    WHERE cp.column_no IS NOT NULL
),

-- Deduplicate: Only one row per (assem, column_no)
deduped_attributes AS (
    SELECT
        assem,
        column_no,
        atr,
        end_atr,
        ROW_NUMBER() OVER (PARTITION BY assem, column_no ORDER BY seq) AS rn
    FROM mapped_attributes
),

filtered_attributes AS (
    SELECT
        assem,
        column_no,
        atr,
        end_atr
    FROM deduped_attributes
    WHERE rn = 1
),

-- Pivot
pivoted_attributes AS (
    SELECT
        assem,

        MAX(CASE WHEN column_no = 1 THEN atr END) AS atr_cat_01,
        MAX(CASE WHEN column_no = 2 THEN atr END) AS atr_cat_02,
        MAX(CASE WHEN column_no = 3 THEN atr END) AS atr_cat_03,
        MAX(CASE WHEN column_no = 4 THEN atr END) AS atr_cat_04,
        MAX(CASE WHEN column_no = 5 THEN atr END) AS atr_cat_05,

        MAX(CASE WHEN column_no = 1 THEN end_atr END) AS end_atr_cat_01,
        MAX(CASE WHEN column_no = 2 THEN end_atr END) AS end_atr_cat_02,
        MAX(CASE WHEN column_no = 3 THEN end_atr END) AS end_atr_cat_03,
        MAX(CASE WHEN column_no = 4 THEN end_atr END) AS end_atr_cat_04,
        MAX(CASE WHEN column_no = 5 THEN end_atr END) AS end_atr_cat_05

    FROM filtered_attributes
    GROUP BY assem
)

SELECT
    *
FROM pivoted_attributes
